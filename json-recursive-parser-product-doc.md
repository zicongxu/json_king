# JSON 递归解析器 Web 工具产品文档

## 1. 产品概述

### 1.1 背景

在接口调试、埋点排查、配置排错等场景下，JSON 数据中常出现“JSON 字符串嵌套 JSON”的情况，例如某个字段的值是被转义后的 JSON 文本：

```json
"config": "{\"name\":\"test\",\"detail\":\"{\\\"id\\\":123}\"}"
```

这类数据在普通 JSON 查看工具中难以直接阅读，需要手动复制、去转义、单独解析，效率低且容易出错。

本工具希望在浏览 JSON 时，支持对这类“JSON 字符串 value”进行一键逐层解析，从而快速看清真实结构，提升排查效率。

### 1.2 产品目标

- 支持用户粘贴任意合法 JSON 文本，并结构化展示其内容。
- 当某个 value 为“JSON 格式的字符串”时，提供点击解析能力，弹出浮层展示解析后的结构。
- 支持对解析结果中继续出现的“JSON 字符串 value”进行递归解析，直至无法再解析。
- 全流程在浏览器本地完成，纯前端实现，不上传数据到服务器。

### 1.3 目标用户

- **开发/测试工程师**：接口调试、埋点排查、配置验证。
- **数据/运营/产品同学**：只读查看复杂配置字段的真实结构，辅助理解业务逻辑。

## 2. 核心概念

- **原始 JSON**：用户输入或粘贴的一段 JSON 文本，可以是对象或数组。
- **JSON 字符串 value**：某个字段的 value 类型为字符串，且该字符串内容本身可被 `JSON.parse` 成功解析为对象或数组。解析结果为基础类型时，当前实现不会作为“可递归解析的 JSON 字符串”处理。
- **解析层级（层数）**：
  - 第一次点击原始 JSON 中的某个 JSON 字符串 value，弹出的浮层记为“第 1 层解析”。
  - 在第 1 层浮层中继续点击一个 JSON 字符串 value，弹出的浮层记为“第 2 层解析”。
  - 依此类推，形成一个递归解析的层级链路。

## 3. 核心功能与逻辑

### 3.1 主视图 JSON 展示

- 用户在输入区粘贴或输入 JSON 文本。
- 工具在用户停止输入约 800ms 后自动尝试对文本执行 `JSON.parse`：
  - 若解析成功，将结果格式化为美观缩进并以树形结构展示在主视图中；
  - 若解析失败，保留原始输入，仅通过顶部 toast 提示“JSON 解析失败”，不刷新结构化视图。
- 主视图支持：
  - 对象/数组嵌套展示。
  - 节点折叠/展开。
  - key 和 value 使用不同颜色高亮（可参考常见 JSON Viewer 风格）。
- 解析成功后，输入面板会自动隐藏，主视图占满可用宽度；顶部左侧提供“全屏/退出”切换按钮，用户可随时重新打开或收起输入面板。

### 3.2 JSON 字符串 value 判定规则

当某个字段的 value 满足以下条件时，认为其为“可解析的 JSON 字符串 value”并提供点击解析能力：

1. value 的原始类型为字符串。
2. 对字符串进行 `trim()` 后：
   - 若首字符不是 `{` 或 `[`，直接判定为普通字符串，不再尝试解析；
   - 若首字符为 `{` 或 `[`，再尝试执行 `JSON.parse`；
3. 仅当 `JSON.parse` 成功且结果为非 null 的对象或数组时，才判定为“可解析 JSON 字符串”；
4. 其他情况（解析失败或结果为基础类型）均视为普通字符串，不提供“点击解析 JSON”能力。

上述策略既避免了数值型字符串等误判为 JSON，又减少了无意义的解析尝试。

### 3.3 点击解析与浮层展示

- 对于被判定为“可解析 JSON 字符串”的 value：
  - 在主视图中以特殊样式展示（详见 4.1）。
  - 用户点击该 value 后，弹出一个解析浮层。
- 浮层内逻辑：
  - 对该 value 执行 `JSON.parse`，获取解析结果；
  - 若结果为对象或数组：按与主视图相同的树形结构展示键值对；
  - 若结果为基础类型：当前实现不会通过“点击解析 JSON 字符串”路径进入该浮层，用户可以通过“编辑浮层”能力查看和修改任意类型的值（见 3.5）。
- 浮层中若再次出现“可解析 JSON 字符串 value”，用户可继续点击，弹出新的浮层进行递归解析。

### 3.4 递归解析与层级管理

- 使用“浮层栈”模型管理解析层级：
  - 栈中的每一项代表一个解析层，对应一次点击。
  - 每个栈元素记录：
    - `level`：当前解析层级（从 1 开始递增）。
    - `path`：从原始 JSON 根节点到当前字段的路径（如 `config.detail`）。
    - `rawStringValue`：当前被解析的原始字符串值。
    - `parsedValue`：`JSON.parse` 之后的结果。
- 当用户点击可解析 value 时，将新的解析信息 `push` 入栈，并据此渲染新的浮层。
- 当用户关闭最上层浮层时，将栈顶元素 `pop` 出栈，界面回退到上一层解析视图；
- 当栈清空时，用户回到主视图，仅保留原始 JSON 展示。

可根据需要设置最大解析层级（例如 10～20 层）以防止极端递归导致的性能和体验问题，当达到上限时给出“已达最大解析层级”的提示。（当前实现未强制限制层级深度，实际使用中可根据性能情况评估是否需要增加该限制。）

### 3.5 编辑与递归保存

- 主视图提供“编辑”按钮，可将当前完整 JSON 切换为带语法高亮的编辑模式：
  - 编辑区域与展示区域共用同一块面板，通过模式切换实现；
  - 编辑过程中支持撤销/改写任意字段；
  - 点击“保存”按钮或使用快捷键（见 6.6）保存后，新的 JSON 会：
    - 写回主视图结构化展示；
    - 写回顶部输入框中的原始 JSON 文本；
    - 关闭所有解析浮层，保证根数据一致。
- 对任意层级的某个字段，用户可通过右键菜单中的“编辑”进入“值编辑浮层”：
  - 浮层以 JSON 形式展示该字段当前值（对象/数组/基础类型均支持）；
  - 用户在浮层中修改后保存，变更将自下而上递归写回：
    - 更新当前浮层的解析结果；
    - 更新上层浮层（若有）对应字段的值；
    - 最终更新到根 JSON，并同步到顶部输入框；
  - 编辑浮层默认以编辑模式打开，用户可直接修改并保存。

### 3.6 URL / schema 字符串识别

- 对 value 为字符串的字段，工具会额外识别“看起来像链接或自定义 schema”的内容：
  - 形如 `sslocal://...`、`http://...`、`https://...` 等前缀的无空格字符串；
  - 判定规则为：去掉首尾空格后，首字符为字母，且满足 `^[A-Za-z][A-Za-z0-9+.-]*:`。
- 在主视图和浮层中，用户可对这类 value 右键，打开“链接工具菜单”：
  - **打开**：在新标签页中直接打开该链接；
  - **解析**：跳转到工具页面 `https://url.web.bytedance.net/?url=<编码后的链接>`，用于查看或进一步调试该 URL。

## 4. 交互设计

### 4.1 可解析 JSON 字符串的视觉标记

- 所有可解析 JSON 字符串 value 在主视图和浮层视图中均采用统一的视觉样式：
  - 文本颜色：蓝色（例如 `#1677ff`）。
  - 文本下划线：启用下划线，表示可点击。
  - 鼠标悬停：显示指针样式，并出现 tooltip 提示“点击解析 JSON”。
- 不可解析的普通字符串按普通样式展示，不可点击。

### 4.2 浮层样式与行为

- 浮层展现形式：
  - 居中大号对话框，宽高约为视窗宽高的 80%；
  - 内部包含标题栏、工具栏（可选）、内容区域。
- 浮层标题栏：
  - 标题格式：`第 X 层解析 - <字段路径>`，例如：`第 2 层解析 - config.detail`。
  - 右上角提供关闭按钮（`×`）。
- 浮层内容区域：
  - 使用和主视图一致的 JSON 树形渲染逻辑。
  - 支持在“展示模式（view）”与“编辑模式（edit）”之间切换：view 模式下为只读树形视图，edit 模式下为带语法高亮的 JSON 文本编辑区域。
- 浮层关闭方式：
  - 点击右上角关闭按钮，关闭当前层浮层（栈顶）。
  - 点击浮层外部遮罩区域，关闭当前层浮层。
  - 支持键盘 Esc 关闭最上层浮层（可选）。

### 4.3 递归层级的区分

为避免用户在连续弹出的多个浮层之间混淆层级，需要在视觉和信息上明确区分层级：

- 空间叠放：
  - 所有解析浮层均在同一居中区域以 80% 视窗宽高显示，通过遮罩与 z-index 形成“栈式叠放”效果；
  - 当前实现不再采用位置偏移，而是通过标题与层级信息帮助用户感知深度。
- 标题标识：
  - 明确显示“第 X 层解析”，X 与栈深度保持一致；
  - 同时显示当前解析字段的路径信息，便于用户理解上下文。
- 层级回退：
  - 关闭最上层浮层时，上一层浮层保持在原来位置，视图不重排，用户感知为“返回上一层 JSON 视图”。

## 5. 示例场景说明

### 5.1 示例 JSON

原始 JSON 片段：

```json
{
  "config": "{\"name\":\"test\",\"detail\":\"{\\\"id\\\":123}\"}"
}
``

### 5.2 第 1 层解析流程

1. 用户在输入区粘贴上述 JSON。
2. 主视图中展示：

   - `config` 作为 key；
   - value 为字符串 `"{\"name\":\"test\",\"detail\":\"{\\\"id\\\":123}\"}"`，被识别为可解析 JSON 字符串：
     - 文本标蓝 + 下划线；
     - 鼠标 hover 提示“点击解析 JSON”。

3. 用户点击 `config` 对应的 value，弹出“第 1 层解析”浮层，标题为：

   - `第 1 层解析 - config`

4. 浮层内容区域中展示解析后的结构：

```json
{
  "name": "test",
  "detail": "{\"id\":123}"
}
```

5. 其中 `detail` 的 value 再次被识别为可解析 JSON 字符串，并按可点击样式展示。

### 5.3 第 2 层解析流程

1. 用户在第 1 层浮层中点击 `detail` 对应的 value。
2. 弹出“第 2 层解析”浮层，相对上一层向右偏移。
3. 标题示例：

   - `第 2 层解析 - config.detail`

4. 浮层内容展示：

```json
{
  "id": 123
}
```

5. 若其中不再包含可解析 JSON 字符串，则所有 value 按普通样式展示，无法继续点击解析。
6. 用户可通过关闭当前浮层返回第 1 层，再关闭第 1 层返回主视图。

## 6. 功能范围

### 6.1 输入区

- 支持用户粘贴或手动输入 JSON 文本。
- 自动解析/格式化：
  - 用户停止输入约 800ms 后，自动尝试解析 JSON；
  - 若成功，将内容格式化并渲染到主视图，同时更新顶部输入框中的文本；
  - 若失败，保留用户输入，仅通过 toast 提示“JSON 解析失败”，不打断当前输入；
- 解析成功后，输入面板会自动隐藏，主视图获得更大展示空间，用户可通过顶部按钮重新展开输入面板；
- 当前实现未提供单独的“解析/格式化”按钮，后续如有需要可补充显式操作入口。

### 6.2 主视图区（JSON Viewer）

- 树形结构展示对象和数组：
  - 节点支持折叠/展开；
  - 数组元素显示索引；
  - 长文本在单行内展示，通过横向滚动查看完整内容。
- key/value 使用颜色区分，提升可读性；JSON 文本编辑时，采用接近代码编辑器的语法高亮方案（区分 key / string / number / bool / null / 标点）。
- 对“可解析 JSON 字符串 value”增加点击解析能力，并始终保持样式一致。
- 支持节点折叠状态记忆：用户对对象/数组节点折叠后，再次渲染仍保持折叠或展开状态。
- 主视图中提供以下交互增强：
  - 双击空白区域快速进入编辑模式；
  - 在编辑模式中，双击空白区域可触发保存并返回展示模式（前提是当前文本是合法 JSON）。

### 6.3 解析浮层

- 标题：显示解析层级与路径。
- 内容：与主视图区相同的 JSON Viewer 能力，支持折叠/展开、点击继续解析，并可切换到编辑模式编辑当前层数据。
- 关闭：
  - 右上角关闭按钮；
  - 点击遮罩；
  - Esc 键（可选）。
- 工具：
  - 在浮层右上方显示“JSON”标签；
-  - 提供“复制”“压缩”按钮，一键复制当前浮层对应的 JSON：
    - 复制：以带缩进的格式复制；
    - 压缩：以紧凑的一行 JSON 复制，便于嵌入日志或参数；
  - 在标题区域展示完整字段路径，并支持一键复制 fullPath，路径过长时自动省略中间部分以保证按钮区域完整显示。

### 6.4 右键菜单与高级操作

- 对 key 的右键菜单：
  - **复制**：复制该字段当前 value（自动根据类型选择合适的字符串表示）；
  - **压缩**：以紧凑 JSON 形式复制该字段 value；
  - **编辑**：打开“值编辑浮层”，对该字段 value 进行 JSON 级别编辑并递归保存。
- 对 URL / schema 字符串 value 的右键菜单：
  - **打开**：在新标签页打开链接；
  - **解析**：跳转到 URL 调试工具并附带当前链接作为参数（见 3.6）。

### 6.5 编辑体验与滚动同步

- 编辑模式下，主视图和浮层统一使用“叠加高亮 + 透明文本”的方案确保：
  - 编辑区域可正常输入/选择；
  - 背景高亮层实时反映 JSON 结构和语法高亮。
- 在如下场景中，会同步垂直滚动条的“相对位置”以提升体验：
  - 从展示模式进入编辑模式时，编辑区域的滚动位置对齐到原展示区域的相对位置；
  - 从编辑模式保存返回展示模式时，展示区域的滚动位置对齐到保存前编辑区域的相对位置；
  - 浮层中从 view 切换到 edit，再从 edit 保存回 view 时也保持同一段内容出现在可视区域附近。

### 6.6 键盘快捷键

- 支持通用保存快捷键：
  - `Cmd + S`（macOS）或 `Ctrl + S`（Windows / Linux）；
  - 若当前顶层浮层处于编辑模式，则优先保存该浮层内容；
  - 否则若主视图处于编辑模式，则保存根 JSON；
  - 保存成功后统一以 toast 提示“已保存”。

## 7. 异常与边界处理

### 7.1 非法 JSON 输入

- 当用户输入的原始文本无法被 `JSON.parse` 解析时：
  - 不更新主视图结构，保留上一次成功解析的结果（如有）；
  - 通过顶部 toast 提示“JSON 解析失败”，不改变当前结构化视图内容，避免误删用户输入。
- 确保无论解析成功或失败，页面不会崩溃或卡死。

### 7.2 超大 JSON

- 对于体量较大的 JSON（例如超过 1MB）：
  - 建议默认折叠部分深层节点，避免首屏渲染过慢；
  - 必要时可引入虚拟滚动或懒加载方案（产品层面允许后续技术演进）。

### 7.3 递归解析深度

- 为防止极端情况下的深度递归影响体验，可以设置最大解析层级限制，例如 10～20 层。
- 当用户继续点击但已达到最大层级时，提示“已达到最大解析层级，不再继续解析”。（当前实现未强制限制层级深度，实际使用中可根据性能情况评估是否需要增加该限制。）

### 7.4 解析结果为基础类型

- 若 JSON 字符串解析结果为：字符串、数字、布尔值或 null：
  - 当前实现不会以“点击解析 JSON 字符串”的方式进入浮层，而是通过“值编辑浮层”统一处理任意类型的值展示与修改。

### 7.5 换行和不可见字符

- 对包含换行或控制字符的字符串：
  - 可以显示转义后的文本（例如以 `\n` 形式展示换行）；
  - 或在视图中保留换行，但提供一键复制原始内容。

### 7.6 安全性

- 工具仅执行 `JSON.parse` 和前端渲染，不执行任何来自数据内容的脚本。
- 默认不发起任何网络请求，不上传用户输入的 JSON 内容。

## 8. 非功能需求

- **实现方式**：纯前端实现，无后端依赖，可部署为静态页面，也可打包为 Chrome 浏览器扩展，方便在日常开发环境中随时打开使用。
- **兼容性**：兼容主流现代浏览器（Chrome/Edge/Safari 最新两个大版本）。
- **性能目标**：
  - 一般规模（< 1MB）的 JSON 在 1 秒内完成解析与首屏渲染为原则目标；
  - 解析 JSON 字符串时的 `JSON.parse` 调用应避免重复和无意义尝试。
- **可用性**：
  - 可解析字段标记明显，交互路径连贯；
  - 浮层层级和回退逻辑直观易懂。

## 9. 版本规划（建议）

### 9.1 MVP 版本

- 输入 JSON 并渲染主视图。
- 识别 JSON 字符串 value 并提供点击解析能力（仅对象/数组）。
- 支持单层浮层解析和关闭。

### 9.2 V1 版本

- 完整的递归解析与浮层栈管理（实际实现采用“同位叠放 + 标题层级提示”的方案）。
- 浮层标题显示层级和字段路径，并支持一键复制路径。
- 浮层内复制解析结果能力（复制/压缩）。

### 9.3 V2 版本（可选后续）

- 针对大 JSON 的性能优化（虚拟列表、懒渲染等）。
- 最大层级配置项、主题切换、自定义配色等高级功能。
- 更丰富的链接解析能力（如内嵌预览、常用内部工具跳转等）。
